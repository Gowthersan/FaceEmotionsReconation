<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>D√©tection d'√âmotions</title>
    <style>
      :root {
        --primary: #4361ee;
        --success: #06d6a0;
        --danger: #ef476f;
        --dark: #073b4c;
        --light: #f8f9fa;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        width: 100%;
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
      }

      .header {
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px;
        text-align: center;
      }

      .content {
        display: flex;
        flex-direction: column;
        padding: 30px;
      }

      @media (min-width: 768px) {
        .content {
          flex-direction: row;
        }
      }

      .camera-section {
        flex: 1;
        padding: 15px;
      }

      .results-section {
        flex: 1;
        padding: 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .video-container {
        position: relative;
        background: black;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        aspect-ratio: 4/3;
      }

      #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .controls {
        margin-top: 20px;
        display: flex;
        justify-content: center;
        gap: 15px;
      }

      button {
        padding: 12px 25px;
        border: none;
        border-radius: 50px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      #startBtn {
        background: var(--success);
        color: white;
      }

      #stopBtn {
        background: var(--danger);
        color: white;
      }

      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 7px 14px rgba(0, 0, 0, 0.15);
      }

      button:active {
        transform: translateY(1px);
      }

      .result-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .emotion-display {
        font-size: 3.5rem;
        margin: 20px 0;
      }

      .confidence-meter {
        height: 25px;
        background: #e0e0e0;
        border-radius: 12px;
        margin: 20px 0;
        overflow: hidden;
      }

      .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--success));
        border-radius: 12px;
        transition: width 0.5s ease;
      }

      .confidence-value {
        font-size: 18px;
        font-weight: bold;
        color: var(--dark);
      }

      .emotion-legend {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-top: 25px;
      }

      .emotion-item {
        background: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      footer {
        text-align: center;
        padding: 20px;
        color: white;
        font-size: 14px;
        background: rgba(0, 0, 0, 0.7);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>D√©tection d'√âmotions en Temps R√©el</h1>
        <p>Analyse d'expressions faciales par intelligence artificielle</p>
      </div>

      <div class="content">
        <div class="camera-section">
          <div class="video-container">
            <video id="video" autoplay playsinline></video>
          </div>
          <div class="controls">
            <button id="startBtn">D√©marrer</button>
            <button id="stopBtn">Arr√™ter</button>
          </div>
        </div>

        <div class="results-section">
          <div class="result-card">
            <h2>Votre √âmotion</h2>
            <div id="emotion" class="emotion-display">üòê</div>
            <div class="confidence-meter">
              <div id="confidenceFill" class="confidence-fill" style="width: 0%"></div>
            </div>
            <div id="confidenceValue" class="confidence-value">0% de confiance</div>

            <div class="emotion-legend">
              <div class="emotion-item">üò† Col√®re</div>
              <div class="emotion-item">ü§¢ D√©go√ªt</div>
              <div class="emotion-item">üò® Peur</div>
              <div class="emotion-item">üòÑ Joie</div>
              <div class="emotion-item">üò¢ Tristesse</div>
              <div class="emotion-item">üò≤ Surprise</div>
              <div class="emotion-item">üòê Neutre</div>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <p>Technologies utilis√©es : Django, TensorFlow, OpenCV, MediaDevices API</p>
      </footer>
    </div>

    <script>
      // √âl√©ments DOM
      const video = document.getElementById('video');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const emotionDisplay = document.getElementById('emotion');
      const confidenceFill = document.getElementById('confidenceFill');
      const confidenceValue = document.getElementById('confidenceValue');

      // Variables globales
      let stream = null;
      let detectionInterval = null;
      const emotionEmojis = {
        Col√®re: 'üò†',
        D√©go√ªt: 'ü§¢',
        Peur: 'üò®',
        Joie: 'üòÑ',
        Tristesse: 'üò¢',
        Surprise: 'üò≤',
        Neutre: 'üòê'
      };

      // D√©marrer la cam√©ra
      startBtn.addEventListener('click', async () => {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user' },
            audio: false
          });
          video.srcObject = stream;
          startBtn.disabled = true;
          stopBtn.disabled = false;

          // D√©marrer la d√©tection p√©riodique
          detectionInterval = setInterval(captureAndDetect, 2000);
        } catch (err) {
          console.error("Erreur d'acc√®s √† la cam√©ra:", err);
          alert("Impossible d'acc√©der √† la cam√©ra. Veuillez v√©rifier les permissions.");
        }
      });

      // Arr√™ter la cam√©ra
      stopBtn.addEventListener('click', () => {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
          stream = null;
        }
        clearInterval(detectionInterval);
        startBtn.disabled = false;
        stopBtn.disabled = true;
        emotionDisplay.textContent = 'üòê';
        confidenceFill.style.width = '0%';
        confidenceValue.textContent = '0% de confiance';
      });

      // Capturer une image et envoyer au serveur
      function captureAndDetect() {
        if (!stream) return;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const imageData = canvas.toDataURL('image/jpeg');

        // Envoyer l'image au serveur
        fetch('/detect/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: `image=${encodeURIComponent(imageData)}`
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.emotion) {
              emotionDisplay.textContent = emotionEmojis[data.emotion] || 'üòê';
              const confidence = data.confidence;
              confidenceFill.style.width = `${confidence}%`;
              confidenceValue.textContent = `${confidence}% de confiance`;
            }
          })
          .catch((error) => {
            console.error('Erreur de d√©tection:', error);
          });
      }

      // Helper pour r√©cup√©rer le cookie CSRF
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + '=') {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    </script>
  </body>
</html>
